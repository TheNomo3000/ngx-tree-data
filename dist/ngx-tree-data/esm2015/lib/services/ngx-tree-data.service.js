import * as tslib_1 from "tslib";
import { Injectable } from '@angular/core';
import { BehaviorSubject } from 'rxjs';
import { PlatformLocation } from '@angular/common';
import { ItemNode } from '../models/models';
import * as i0 from "@angular/core";
import * as i1 from "@angular/common";
let NgxTreeDataService = class NgxTreeDataService {
    constructor(platformLocation) {
        this.platformLocation = platformLocation;
        this.dataChange = new BehaviorSubject(null);
        this.dataSource = [];
    }
    get data() { return this.dataChange.value; }
    initialize(data) {
        this.externalData = data;
        const newData = this.generateData(this.externalData);
        this.dataChange.next(newData);
    }
    generateData(data) {
        this.dataSource = this.generateDataWithCode(data);
        this.treeData = this.dataSource;
        return this.buildFileTree(this.dataSource, '0');
    }
    generateDataWithCode(data) {
        const newData = [];
        let parent = 1;
        data.forEach(item => {
            newData.push({
                text: item.text,
                id: item.id,
                code: `0.${parent}`,
                selected: item.selected,
                data: item.data
            });
            const childrens = item.children;
            if (childrens.length > 0) {
                let children = 1;
                childrens.forEach(el => {
                    const itemChildren = {
                        text: el.text,
                        code: `0.${parent}.${children}`,
                        selected: el.selected,
                        id: el.id,
                        data: el.data
                    };
                    newData.push(itemChildren);
                    children++;
                });
            }
            parent++;
        });
        return newData;
    }
    buildFileTree(obj, level) {
        return obj.filter(o => o.code.startsWith(level + '.')
            && (o.code.match(/\./g) || []).length === (level.match(/\./g) || []).length + 1)
            .map(o => {
            const node = new ItemNode();
            node.item = o.text;
            node.selected = o.selected;
            node.id = o.id;
            node.code = o.code;
            node.data = o.data;
            const children = obj.filter(so => so.code.startsWith(level + '.'));
            if (children && children.length > 0) {
                node.children = this.buildFileTree(children, o.code);
            }
            return node;
        });
    }
    filter(filterText) {
        this.treeData = this.generateDataWithCode(this.externalData);
        let filteredTreeData;
        if (filterText) {
            filteredTreeData = this.treeData.filter(d => d.text.toLocaleLowerCase().indexOf(filterText.toLocaleLowerCase()) > -1);
            Object.assign([], filteredTreeData).forEach(ftd => {
                let str = ftd.code;
                while (str.lastIndexOf('.') > -1) {
                    const index = str.lastIndexOf('.');
                    str = str.substring(0, index);
                    if (filteredTreeData.findIndex(t => t.code === str) === -1) {
                        const obj = this.treeData.find(d => d.code === str);
                        if (obj) {
                            filteredTreeData.push(obj);
                        }
                    }
                }
            });
        }
        else {
            filteredTreeData = this.treeData;
        }
        const data = this.buildFileTree(filteredTreeData, '0');
        this.dataChange.next(data);
    }
    updateData(items, externalData) {
        this.externalData = this.recursiveUpdate(items, this.externalData);
    }
    recursiveUpdate(items, externalData) {
        externalData.map(data => {
            data.selected = false;
            items.forEach(el => {
                if (el.id === data.id) {
                    data.selected = true;
                }
            });
            const children = data.children;
            if (children && data.children.length > 0) {
                this.recursiveUpdate(items, children);
            }
        });
        return externalData;
    }
};
NgxTreeDataService.ngInjectableDef = i0.ɵɵdefineInjectable({ factory: function NgxTreeDataService_Factory() { return new NgxTreeDataService(i0.ɵɵinject(i1.PlatformLocation)); }, token: NgxTreeDataService, providedIn: "root" });
NgxTreeDataService = tslib_1.__decorate([
    Injectable({
        providedIn: 'root'
    }),
    tslib_1.__metadata("design:paramtypes", [PlatformLocation])
], NgxTreeDataService);
export { NgxTreeDataService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmd4LXRyZWUtZGF0YS5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vbmd4LXRyZWUtZGF0YS8iLCJzb3VyY2VzIjpbImxpYi9zZXJ2aWNlcy9uZ3gtdHJlZS1kYXRhLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDM0MsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUN2QyxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUNuRCxPQUFPLEVBQUUsUUFBUSxFQUEwQixNQUFNLGtCQUFrQixDQUFDOzs7QUFJcEUsSUFBYSxrQkFBa0IsR0FBL0IsTUFBYSxrQkFBa0I7SUFPN0IsWUFBb0IsZ0JBQWtDO1FBQWxDLHFCQUFnQixHQUFoQixnQkFBZ0IsQ0FBa0I7UUFOdEQsZUFBVSxHQUFHLElBQUksZUFBZSxDQUFjLElBQUksQ0FBQyxDQUFDO1FBR3BELGVBQVUsR0FBRyxFQUFFLENBQUM7SUFHeUMsQ0FBQztJQUYxRCxJQUFJLElBQUksS0FBa0IsT0FBUSxJQUFJLENBQUMsVUFBVSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7SUFJMUQsVUFBVSxDQUFDLElBQWlCO1FBQzFCLElBQUksQ0FBQyxZQUFZLEdBQUcsSUFBSSxDQUFDO1FBQ3pCLE1BQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxDQUFDO1FBQ3JELElBQUksQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBQ2hDLENBQUM7SUFFRCxZQUFZLENBQUMsSUFBaUI7UUFDNUIsSUFBSSxDQUFDLFVBQVUsR0FBRyxJQUFJLENBQUMsb0JBQW9CLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDbEQsSUFBSSxDQUFDLFFBQVEsR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDO1FBQ2hDLE9BQU8sSUFBSSxD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c0g5QjtTQXRIWSxrQkFBa0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBCZWhhdmlvclN1YmplY3QgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IFBsYXRmb3JtTG9jYXRpb24gfSBmcm9tICdAYW5ndWxhci9jb21tb24nO1xuaW1wb3J0IHsgSXRlbU5vZGUsIFRyZWVEYXRhLCBJdGVtRmxhdE5vZGUgfSBmcm9tICcuLi9tb2RlbHMvbW9kZWxzJztcbkBJbmplY3RhYmxlKHtcbiAgcHJvdmlkZWRJbjogJ3Jvb3QnXG59KVxuZXhwb3J0IGNsYXNzIE5neFRyZWVEYXRhU2VydmljZSB7XG4gIGRhdGFDaGFuZ2UgPSBuZXcgQmVoYXZpb3JTdWJqZWN0PEl0ZW1Ob2RlIFtdPihudWxsKTtcbiAgdHJlZURhdGE6IGFueSBbXTtcbiAgZXh0ZXJuYWxEYXRhOiBUcmVlRGF0YSBbXTtcbiAgZGF0YVNvdXJjZSA9IFtdO1xuICBnZXQgZGF0YSgpOiBJdGVtTm9kZSBbXSB7IHJldHVybiAgdGhpcy5kYXRhQ2hhbmdlLnZhbHVlOyB9XG4gIGxvYWRlcklkOiBzdHJpbmc7XG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgcGxhdGZvcm1Mb2NhdGlvbjogUGxhdGZvcm1Mb2NhdGlvbikge31cblxuICBpbml0aWFsaXplKGRhdGE6IFRyZWVEYXRhIFtdKSB7XG4gICAgdGhpcy5leHRlcm5hbERhdGEgPSBkYXRhO1xuICAgIGNvbnN0IG5ld0RhdGEgPSB0aGlzLmdlbmVyYXRlRGF0YSh0aGlzLmV4dGVybmFsRGF0YSk7XG4gICAgdGhpcy5kYXRhQ2hhbmdlLm5leHQobmV3RGF0YSk7XG4gIH1cblxuICBnZW5lcmF0ZURhdGEoZGF0YTogVHJlZURhdGEgW10pOiBJdGVtTm9kZSBbXSB7XG4gICAgdGhpcy5kYXRhU291cmNlID0gdGhpcy5nZW5lcmF0ZURhdGFXaXRoQ29kZShkYXRhKTtcbiAgICB0aGlzLnRyZWVEYXRhID0gdGhpcy5kYXRhU291cmNlO1xuICAgIHJldHVybiB0aGlzLmJ1aWxkRmlsZVRyZWUodGhpcy5kYXRhU291cmNlLCAnMCcpO1xuICB9XG5cbiAgcHJpdmF0ZSBnZW5lcmF0ZURhdGFXaXRoQ29kZShkYXRhOiBUcmVlRGF0YSBbXSk6IGFueVtdIHtcbiAgICBjb25zdCBuZXdEYXRhID0gW107XG4gICAgbGV0IHBhcmVudCA9IDE7XG4gICAgZGF0YS5mb3JFYWNoKGl0ZW0gPT4ge1xuICAgICAgbmV3RGF0YS5wdXNoKFxuICAgICAgICB7XG4gICAgICAgICAgdGV4dDogaXRlbS50ZXh0LFxuICAgICAgICAgIGlkOiBpdGVtLmlkLFxuICAgICAgICAgIGNvZGU6IGAwLiR7cGFyZW50fWAsXG4gICAgICAgICAgc2VsZWN0ZWQ6IGl0ZW0uc2VsZWN0ZWQsXG4gICAgICAgICAgZGF0YTogaXRlbS5kYXRhXG4gICAgICAgIH1cbiAgICAgICk7XG4gICAgICBjb25zdCBjaGlsZHJlbnMgPSBpdGVtLmNoaWxkcmVuO1xuICAgICAgaWYgKGNoaWxkcmVucy5sZW5ndGggPiAwKSB7XG4gICAgICAgIGxldCBjaGlsZHJlbiA9IDE7XG4gICAgICAgIGNoaWxkcmVucy5mb3JFYWNoKGVsID0+IHtcbiAgICAgICAgICBjb25zdCBpdGVtQ2hpbGRyZW4gPSB7XG4gICAgICAgICAgICB0ZXh0OiBlbC50ZXh0LFxuICAgICAgICAgICAgY29kZTogYDAuJHtwYXJlbnR9LiR7Y2hpbGRyZW59YCxcbiAgICAgICAgICAgIHNlbGVjdGVkOiBlbC5zZWxlY3RlZCxcbiAgICAgICAgICAgIGlkOiBlbC5pZCxcbiAgICAgICAgICAgIGRhdGE6IGVsLmRhdGFcbiAgICAgICAgICB9O1xuICAgICAgICAgIG5ld0RhdGEucHVzaChpdGVtQ2hpbGRyZW4pO1xuICAgICAgICAgIGNoaWxkcmVuKys7XG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgICAgcGFyZW50Kys7XG4gICAgfSk7XG4gICAgcmV0dXJuIG5ld0RhdGE7XG4gIH1cblxuICBwcml2YXRlIGJ1aWxkRmlsZVRyZWUob2JqOiBhbnlbXSwgbGV2ZWw6IHN0cmluZyk6IEl0ZW1Ob2RlIFtdIHtcbiAgICByZXR1cm4gb2JqLmZpbHRlcihvID0+XG4gICAgICAoby5jb2RlIGFzIHN0cmluZykuc3RhcnRzV2l0aChsZXZlbCArICcuJylcbiAgICAgICYmIChvLmNvZGUubWF0Y2goL1xcLi9nKSB8fCBbXSkubGVuZ3RoID09PSAobGV2ZWwubWF0Y2goL1xcLi9nKSB8fCBbXSkubGVuZ3RoICsgMVxuICAgIClcbiAgICAgIC5tYXAobyA9PiB7XG4gICAgICAgIGNvbnN0IG5vZGUgPSBuZXcgSXRlbU5vZGUoKTtcbiAgICAgICAgbm9kZS5pdGVtID0gby50ZXh0O1xuICAgICAgICBub2RlLnNlbGVjdGVkID0gby5zZWxlY3RlZDtcbiAgICAgICAgbm9kZS5pZCA9IG8uaWQ7XG4gICAgICAgIG5vZGUuY29kZSA9IG8uY29kZTtcbiAgICAgICAgbm9kZS5kYXRhID0gby5kYXRhO1xuICAgICAgICBjb25zdCBjaGlsZHJlbiA9IG9iai5maWx0ZXIoc28gPT4gKHNvLmNvZGUgYXMgc3RyaW5nKS5zdGFydHNXaXRoKGxldmVsICsgJy4nKSk7XG4gICAgICAgIGlmIChjaGlsZHJlbiAmJiBjaGlsZHJlbi5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICBub2RlLmNoaWxkcmVuID0gdGhpcy5idWlsZEZpbGVUcmVlKGNoaWxkcmVuLCBvLmNvZGUpO1xuICAgICAgICAgIH1cbiAgICAgICAgcmV0dXJuIG5vZGU7XG4gICAgICB9KTtcbiAgfVxuXG4gIHB1YmxpYyBmaWx0ZXIoZmlsdGVyVGV4dDogc3RyaW5nKSB7XG4gICAgdGhpcy50cmVlRGF0YSA9IHRoaXMuZ2VuZXJhdGVEYXRhV2l0aENvZGUodGhpcy5leHRlcm5hbERhdGEpO1xuICAgIGxldCBmaWx0ZXJlZFRyZWVEYXRhO1xuICAgIGlmIChmaWx0ZXJUZXh0KSB7XG4gICAgICBmaWx0ZXJlZFRyZWVEYXRhID0gdGhpcy50cmVlRGF0YS5maWx0ZXIoZCA9PiBkLnRleHQudG9Mb2NhbGVMb3dlckNhc2UoKS5pbmRleE9mKGZpbHRlclRleHQudG9Mb2NhbGVMb3dlckNhc2UoKSkgPiAtMSk7XG4gICAgICBPYmplY3QuYXNzaWduKFtdLCBmaWx0ZXJlZFRyZWVEYXRhKS5mb3JFYWNoKGZ0ZCA9PiB7XG4gICAgICAgIGxldCBzdHIgPSAoZnRkLmNvZGUgYXMgc3RyaW5nKTtcbiAgICAgICAgd2hpbGUgKHN0ci5sYXN0SW5kZXhPZignLicpID4gLTEpIHtcbiAgICAgICAgICBjb25zdCBpbmRleCA9IHN0ci5sYXN0SW5kZXhPZignLicpO1xuICAgICAgICAgIHN0ciA9IHN0ci5zdWJzdHJpbmcoMCwgaW5kZXgpO1xuICAgICAgICAgIGlmIChmaWx0ZXJlZFRyZWVEYXRhLmZpbmRJbmRleCh0ID0+IHQuY29kZSA9PT0gc3RyKSA9PT0gLTEpIHtcbiAgICAgICAgICAgIGNvbnN0IG9iaiA9IHRoaXMudHJlZURhdGEuZmluZChkID0+IGQuY29kZSA9PT0gc3RyKTtcbiAgICAgICAgICAgIGlmIChvYmopIHtcbiAgICAgICAgICAgICAgZmlsdGVyZWRUcmVlRGF0YS5wdXNoKG9iaik7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9IGVsc2Uge1xuICAgICAgZmlsdGVyZWRUcmVlRGF0YSA9IHRoaXMudHJlZURhdGE7XG4gICAgfVxuICAgIGNvbnN0IGRhdGEgPSB0aGlzLmJ1aWxkRmlsZVRyZWUoZmlsdGVyZWRUcmVlRGF0YSwgJzAnKTtcbiAgICB0aGlzLmRhdGFDaGFuZ2UubmV4dChkYXRhKTtcbiAgfVxuXG4gIHB1YmxpYyB1cGRhdGVEYXRhKGl0ZW1zOiBJdGVtRmxhdE5vZGUgW10sIGV4dGVybmFsRGF0YSA/OiBUcmVlRGF0YSBbXSB8IG51bGwpOiB2b2lkIHtcbiAgICB0aGlzLmV4dGVybmFsRGF0YSA9IHRoaXMucmVjdXJzaXZlVXBkYXRlKGl0ZW1zLCB0aGlzLmV4dGVybmFsRGF0YSk7XG4gIH1cblxuICByZWN1cnNpdmVVcGRhdGUoaXRlbXM6IEl0ZW1GbGF0Tm9kZVtdLCBleHRlcm5hbERhdGE6IFRyZWVEYXRhIFtdKTogVHJlZURhdGEgW10ge1xuICAgIGV4dGVybmFsRGF0YS5tYXAoZGF0YSA9PiB7XG4gICAgICBkYXRhLnNlbGVjdGVkID0gZmFsc2U7XG4gICAgICBpdGVtcy5mb3JFYWNoKGVsID0+IHtcbiAgICAgICAgaWYgKGVsLmlkID09PSBkYXRhLmlkKSB7XG4gICAgICAgICAgZGF0YS5zZWxlY3RlZCA9IHRydWU7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgICAgY29uc3QgY2hpbGRyZW4gPSBkYXRhLmNoaWxkcmVuO1xuICAgICAgaWYgKGNoaWxkcmVuICYmIGRhdGEuY2hpbGRyZW4ubGVuZ3RoID4gMCkge1xuICAgICAgICB0aGlzLnJlY3Vyc2l2ZVVwZGF0ZShpdGVtcywgY2hpbGRyZW4pO1xuICAgICAgfVxuICAgIH0pO1xuICAgIHJldHVybiBleHRlcm5hbERhdGE7XG4gIH1cbn1cbiJdfQ==